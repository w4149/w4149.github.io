<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能对话系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            /* 滚动条样式优化 */
            .scrollable-area {
                scrollbar-width: thin;
            }
            .scrollable-area::-webkit-scrollbar {
                width: 6px;
            }
            .scrollable-area::-webkit-scrollbar-thumb {
                background-color: rgba(0,0,0,0.2);
                border-radius: 3px;
            }
            
            /* 加载状态样式 */
            .loading {
                color: #6B7280;
                font-style: italic;
            }
            
            /* 消息头像样式 */
            .message-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                flex-shrink: 0;
            }
            
            /* 左侧面板布局 */
            .left-panel {
                width: 320px;
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            
            /* 一寸照比例头像容器 (3:4) */
            .id-photo-container {
                flex: 3;
                min-height: 240px;
                background-color: #f0f2f5;
                overflow: hidden;
                border-radius: 0.75rem;
            }
            
            /* 矩形头像样式 */
            .rect-avatar {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }
            
            /* 输入框区域样式 */
            .input-panel {
                flex: 2;
                min-height: 180px;
            }

            /* 恐龙游戏样式 */
            .dino-game-container {
                margin-top: 1rem;
                border: 1px solid #e0e0e0;
                border-radius: 0.5rem;
                overflow: hidden;
                background-color: #fafafa;
                cursor: pointer; /* 显示点击指针 */
            }
            .game-info {
                padding: 0.5rem 1rem;
                background-color: #f0f0f0;
                display: flex;
                justify-content: flex-end;
                font-size: 0.875rem;
            }
            #gameCanvas {
                width: 100%;
                height: 150px;
                background-color: #ffffff;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-6">
    <div class="container mx-auto max-w-6xl">
        <!-- 主容器：左右布局 -->
        <div class="flex flex-col md:flex-row gap-6 h-[600px]">
            <!-- 左侧区域：头像 + 输入框 -->
            <div class="left-panel">
                <!-- 左侧上部：一寸照比例头像 -->
                <div class="id-photo-container shadow-md">
                    <img id="main-avatar" 
                         src="https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageDOUBAO.png" 
                         alt="智能助手头像" 
                         class="rect-avatar"
                         onerror="this.src='https://picsum.photos/seed/robot/400/533'">
                </div>

                <!-- 左侧下部：输入框区域 -->
                <div class="input-panel bg-white rounded-xl shadow-md p-5 flex flex-col">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">输入消息</h3>
                    <textarea id="input-area" 
                              class="flex-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none" 
                              placeholder="请输入您的问题..."></textarea>
                </div>
            </div>

            <!-- 右侧区域：对话记录 -->
            <div class="flex-1 bg-white rounded-xl shadow-md p-5 flex flex-col">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">对话记录</h3>
                <div id="dialog-container" class="scrollable-area flex-1 overflow-y-auto p-2 space-y-4">
                    <div class="text-gray-400 text-center py-8">
                        开始您的对话吧
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部恐龙游戏区域 -->
        <div class="dino-game-container mt-6">
            <div class="game-info">
                <span id="score">0</span>
            </div>
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>

    <script>
        // ==============================================
        // 聊天功能相关代码
        // ==============================================
        
        // 定义两组头像资源
        const avatarSets = {
            set1: {
                text: '请以温柔助手的语言方式回答下面问题，但不要让人很容易就判断出你的身份，直接说一段文字，不要任何其他东西（比如表情符号、对自己身份的介绍、动作神情的描述）：',
                normal: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageDOUBAO.png',
                thinking: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageDOUBAO_Thinking.png'
            },
            set2: {
                text: '请以积极乐观青年的语言方式回答下面问题，但不要让人很容易就判断出你的身份，直接说一段文字，不要任何其他东西（比如表情符号、对自己身份的介绍、动作神情的描述）：',
                normal: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageGROK.png',
                thinking: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageGROK_Thinking.png'
            },
            set3: {
                text: '请以对科技有一定信心的技术人士的语言方式回答下面问题，但不要让人很容易就判断出你的身份，直接说一段文字，不要任何其他东西（比如表情符号、对自己身份的介绍、动作神情的描述）：',
                normal: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageMUSK.png',
                thinking: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageMUSK_Thinking.png'
            },
            set4: {
                text: '请以严谨理性的语言方式回答下面问题，但不要让人很容易就判断出你的身份，直接说一段文字，不要任何其他东西（比如表情符号、对自己身份的介绍、动作神情的描述）：',
                normal: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageROBOT.png',
                thinking: 'https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/ImageROBOT_Thinking.png'
            }
        };

        // 用户头像（固定）
        const userAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAzNiAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxOCIgY3k9IjE4IiByPSIxOCIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEiLz48L3N2Zz4=';
        
        // 当前使用的头像组（动态切换）
        let currentAvatarSet = avatarSets.set1;

        // DOM元素引用
        const inputArea = document.getElementById('input-area');
        const dialogContainer = document.getElementById('dialog-container');
        const mainAvatar = document.getElementById('main-avatar');

        // 初始化事件监听
        function initEventListeners() {
            // 回车键发送消息（Shift+Enter换行）
            inputArea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessageFromInput();
                }
            });
        }

        // 从输入框发送消息
        function sendMessageFromInput() {
            const text = inputArea.value.trim();
            if (text) {
                sendMessage(text);
                inputArea.value = '';
            }
        }

        // 发送消息并处理流程
        async function sendMessage(text) {
            // 生成1-100的随机数并选择头像组
            const randomNum = Math.floor(Math.random() * 100) + 1;
            currentAvatarSet = randomNum < 20 ? avatarSets.set1 : 
                            (
                                randomNum < 40 ? avatarSets.set2 : 
                                (
                                    randomNum < 60 ? avatarSets.set3 : avatarSets.set4
                                )
                            );
            
            // 在输入问题前添加限定
            wholeText = currentAvatarSet.text + text;
            // 添加用户消息到对话记录
            addToDialog('user', text);
            
            // 切换到思考状态
            setThinkingState(true);
            
            // 添加"正在思考"提示
            const loadingId = `loading-${Date.now()}`;
            addToDialog('ai', '正在思考...', false, loadingId);
            
            try {
                // 调用API获取回复
                const response = await callAssistantAPI(wholeText);
                
                // 显示回复并恢复正常状态
                removeLoadingItem(loadingId);
                addToDialog('ai', response);
                setThinkingState(false);
            } catch (error) {
                // 处理错误
                removeLoadingItem(loadingId);
                addToDialog('ai', `获取回复失败：${error.message}`, true);
                setThinkingState(false);
            }
        }

        // 切换思考状态头像
        function setThinkingState(isThinking) {
            mainAvatar.src = isThinking ? currentAvatarSet.thinking : currentAvatarSet.normal;
            mainAvatar.onerror = () => {
                mainAvatar.src = 'https://picsum.photos/seed/robot/400/533';
            };
        }

        // 调用助手API
        async function callAssistantAPI(query) {
            // 替换为实际API密钥
            const API_KEY = "sk-807f33ba0ae34437bf69c195d5068570";
            const API_URL = "https://api.deepseek.com/chat/completions";
            
            const requestData = {
                model: "deepseek-chat",
                messages: [{ role: "user", content: query }],
                temperature: 0.7,
                max_tokens: 1024
            };
            
            const response = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${API_KEY}`
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP错误: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices?.[0]?.message?.content || "未获取到有效回复";
        }

        // 添加内容到对话记录
        function addToDialog(role, content, isError = false, id = null) {
            const dialogDiv = document.createElement('div');
            dialogDiv.className = `dialog-item flex gap-3 p-2 transition-all ${id || ''}`;
            
            // 确定头像和样式
            const roleClass = role === 'user' ? 'bg-blue-50 text-blue-700' : 'bg-green-50 text-gray-800';
            const avatarSrc = role === 'user' 
                ? userAvatar 
                : (content === '正在思考...' ? currentAvatarSet.thinking : currentAvatarSet.normal);
            
            dialogDiv.innerHTML = `
                <img src="${avatarSrc}" 
                     alt="${role === 'user' ? '用户' : '智能助手'}" 
                     class="message-avatar mt-1"
                     onerror="this.src='${role === 'user' ? userAvatar : 'https://picsum.photos/seed/robot/36/36'}'">
                <div class="flex-1 max-w-[85%]">
                    <div class="p-3 rounded-lg ${roleClass} break-words">${content}</div>
                </div>
            `;
            
            // 加载状态样式
            if (content === '正在思考...') {
                dialogDiv.classList.add('loading');
            }
            
            // 错误状态样式
            if (isError) {
                const messageEl = dialogDiv.querySelector('div.rounded-lg');
                messageEl.classList.remove('bg-green-50', 'text-gray-800');
                messageEl.classList.add('bg-red-50', 'text-red-600');
            }
            
            // 移除初始提示文本
            const initialPrompt = dialogContainer.querySelector('.text-gray-400');
            if (initialPrompt) {
                dialogContainer.removeChild(initialPrompt);
            }
            
            // 添加到对话容器并滚动到底部
            dialogContainer.appendChild(dialogDiv);
            dialogContainer.scrollTop = dialogContainer.scrollHeight;
        }

        // 移除加载提示
        function removeLoadingItem(id) {
            const loadingItem = document.querySelector(`.${id}`);
            if (loadingItem) {
                loadingItem.remove();
            }
        }

        // ==============================================
        // 恐龙跳跃游戏相关代码（仙人掌替换为图片）
        // ==============================================
        
        // 游戏状态枚举
        const GameState = {
            NOT_STARTED: 0,  // 未开始
            RUNNING: 1,      // 运行中
            OVER: 2          // 已结束
        };
        
        // 障碍物图片加载
        const obstacleImage = new Image();
        obstacleImage.src = "https://oiwjj-1325666589.cos.ap-beijing.myqcloud.com/theother_XUBINGstyle.png";
        let imageLoaded = false;
        
        // 图片加载完成事件
        obstacleImage.onload = function() {
            imageLoaded = true;
        };
        
        // 图片加载失败时使用默认样式
        obstacleImage.onerror = function() {
            console.log("障碍物图片加载失败，将使用默认样式");
            imageLoaded = false;
        };
        
        // 游戏变量
        let canvas, ctx;
        let dino = {
            x: 50,
            y: 0,
            width: 40,
            height: 40,
            velocityY: 0,
            jumping: false,
            gravity: 0.6,
            jumpStrength: -12
        };
        
        let obstacles = [];
        let score = 0;
        let gameSpeed = 5;
        let gameState = GameState.NOT_STARTED; // 初始状态为未开始
        let animationId;
        let obstacleTimer;
        let groundHeight = 10; // 地面高度

        // 初始化游戏
        function initGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // 设置canvas尺寸
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // 重置游戏状态
            resetGame();
            
            // 点击游戏区域开始游戏
            canvas.addEventListener('click', () => {
                if (gameState === GameState.NOT_STARTED || gameState === GameState.OVER) {
                    resetGame();
                    gameState = GameState.RUNNING;
                    obstacleTimer = setInterval(createObstacle, 1500);
                }
            });
            
            // 监听空格键跳跃（仅在游戏运行中有效）
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && gameState === GameState.RUNNING) {
                    e.preventDefault();
                    if (!dino.jumping) {
                        dino.jumping = true;
                        dino.velocityY = dino.jumpStrength;
                    }
                }
            });
            
            // 开始游戏循环
            gameLoop();
        }

        // 重置游戏
        function resetGame() {
            // 重置恐龙状态（站在地面上）
            const groundY = canvas.height - groundHeight - dino.height;
            dino.y = groundY;
            dino.velocityY = 0;
            dino.jumping = false;
            
            // 清空障碍物
            obstacles = [];
            if (obstacleTimer) clearInterval(obstacleTimer);
            
            // 重置游戏状态
            score = 0;
            gameSpeed = 5;
            gameState = GameState.NOT_STARTED;
            document.getElementById('score').textContent = '0';
        }

        // 创建障碍物（保持原有尺寸）
        function createObstacle() {
            if (gameState !== GameState.RUNNING) return;
            
            // 保持原有仙人掌尺寸范围
            const minHeight = 30;
            const maxHeight = 60;
            const height = Math.random() * (maxHeight - minHeight) + minHeight;
            const width = 20; // 保持原有宽度
            
            // 计算障碍物Y坐标，使其立在地面上
            const obstacleY = canvas.height - groundHeight - height;
            
            obstacles.push({
                x: canvas.width,
                y: obstacleY,
                width: width,
                height: height
            });
        }

        // 更新游戏状态
        function update() {
            if (gameState !== GameState.RUNNING) return;
            
            // 更新分数
            score++;
            document.getElementById('score').textContent = score.toString();
            
            // 加速游戏
            if (score % 100 === 0) {
                gameSpeed += 0.2;
            }
            
            // 更新恐龙位置（重力和跳跃）
            dino.velocityY += dino.gravity;
            dino.y += dino.velocityY;
            
            // 地面碰撞检测
            const groundY = canvas.height - groundHeight - dino.height;
            if (dino.y >= groundY) {
                dino.y = groundY;
                dino.velocityY = 0;
                dino.jumping = false;
            }
            
            // 更新障碍物位置
            for (let i = 0; i < obstacles.length; i++) {
                obstacles[i].x -= gameSpeed;
                
                // 移除超出画布的障碍物
                if (obstacles[i].x + obstacles[i].width < 0) {
                    obstacles.splice(i, 1);
                    i--;
                }
            }
            
            // 碰撞检测（保持不变，因为尺寸未变）
            checkCollision();
        }

        // 碰撞检测
        function checkCollision() {
            // 恐龙的碰撞边界
            const dinoLeft = dino.x;
            const dinoRight = dino.x + dino.width;
            const dinoTop = dino.y;
            const dinoBottom = dino.y + dino.height;
            
            for (let obstacle of obstacles) {
                // 障碍物的碰撞边界（保持原有尺寸）
                const obstacleLeft = obstacle.x;
                const obstacleRight = obstacle.x + obstacle.width;
                const obstacleTop = obstacle.y;
                const obstacleBottom = obstacle.y + obstacle.height;
                
                // 精确的碰撞检测
                if (dinoRight > obstacleLeft && 
                    dinoLeft < obstacleRight && 
                    dinoBottom > obstacleTop && 
                    dinoTop < obstacleBottom) {
                    gameState = GameState.OVER; // 游戏结束
                    clearInterval(obstacleTimer);
                    return;
                }
            }
        }

        // 绘制游戏
        function draw() {
            // 清空画布
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制地面
            ctx.fillStyle = '#e0e0e0';
            const groundY = canvas.height - groundHeight;
            ctx.fillRect(0, groundY, canvas.width, groundHeight);
            
            // 绘制恐龙
            ctx.fillStyle = '#333';
            ctx.fillRect(dino.x, dino.y, dino.width, dino.height);
            
            // 绘制眼睛
            ctx.fillStyle = 'white';
            ctx.fillRect(dino.x + dino.width - 10, dino.y + 10, 5, 5);
            
            // 绘制障碍物（使用图片，保持原有尺寸）
            if (imageLoaded) {
                for (let obstacle of obstacles) {
                    // 绘制图片，调整图片尺寸以匹配原有仙人掌尺寸
                    ctx.drawImage(
                        obstacleImage, 
                        obstacle.x, 
                        obstacle.y, 
                        obstacle.width, 
                        obstacle.height
                    );
                }
            } else {
                // 图片未加载时使用默认绿色矩形
                ctx.fillStyle = '#4CAF50';
                for (let obstacle of obstacles) {
                    ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                }
            }
            
            // 游戏未开始时显示提示
            /*
            if (gameState === GameState.NOT_STARTED) {
                ctx.fillStyle = 'rgba(100, 100, 100, 0.7)';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('点击开始游戏', canvas.width / 2, canvas.height / 2);
            }
            */
            // 游戏结束时显示提示
            /*
            else if (gameState === GameState.OVER) {
                ctx.fillStyle = 'rgba(150, 150, 150, 0.5)';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('the Other', canvas.width / 2, canvas.height / 2);
            }
            */
        }

        // 游戏主循环
        function gameLoop() {
            update();
            draw();
            animationId = requestAnimationFrame(gameLoop);
        }

        // 初始化应用
        function initApp() {
            initEventListeners();
            initGame();
            
            // 监听窗口大小变化，调整canvas尺寸
            window.addEventListener('resize', () => {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                // 重新计算恐龙和障碍物位置以适应新尺寸
                const groundY = canvas.height - groundHeight - dino.height;
                dino.y = groundY;
                
                obstacles.forEach(obstacle => {
                    obstacle.y = canvas.height - groundHeight - obstacle.height;
                });
            });
        }

        // 启动应用
        initApp();
    </script>
</body>
</html>
